<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Enigma</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

        <script src="enigma.js"></script>

        <link rel="stylesheet" href="main.css">
        <link href='https://fonts.googleapis.com/css?family=Alegreya+Sans:300' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Cutive+Mono' rel='stylesheet' type='text/css'>
    </head>

    <body>
        <h1>Enigma Simulator</h1>

        <div class="enigma-section">
            <div class="input-section">
                <input class="input-text" id="enigma-input" type="text" placeholder="Input">
            </div>

            <div class="output-section">
                <input class="output-text" id="enigma-output" type="text" placeholder="Output" readonly>
            </div>
        </div>

        <div class="configuration-section">
            <h2>Rotors settings</h2>

            <label>Rotor types</label>
            <select class="rotor-type-config" id="rotor-type-left">
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV" selected>IV</option>
                <option value="V">V</option>
            </select>

            <select class="rotor-type-config" id="rotor-type-middle">
                <option value="I">I</option>
                <option value="II" selected>II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
                <option value="V">V</option>
            </select>

            <select class="rotor-type-config" id="rotor-type-right">
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III" selected>III</option>
                <option value="IV">IV</option>
                <option value="V">V</option>
            </select>

            <br>

            <label>Initial position</label>
            <input class="rotor-config" id="rotor-left-pos" type="text" value="Q">
            <input class="rotor-config" id="rotor-middle-pos" type="text" value="I">
            <input class="rotor-config" id="rotor-right-pos" type="text" value="J">

            <br>

            <label>Ring settings</label>
            <input class="rotor-config" id="ring-left-pos" type="text" value="M">
            <input class="rotor-config" id="ring-middle-pos" type="text" value="W">
            <input class="rotor-config" id="ring-right-pos" type="text" value="B">

            <br>

            <h2>Reflector settings</h2>

            <label>Reflector type</label>
            <select class="reflector-config" id="reflector-type">
                <option value="B">B</option>
                <option value="C">C</option>
            </select>

            <br>

            <h2>Plugboard settings</h2>
            <table>
                <tr>
                    <td>
                        <label for="plugboard-A">A</label>
                        <input class="plugboard-config" id="plugboard-A" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-B">B</label>
                        <input class="plugboard-config" id="plugboard-B" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-C">C</label>
                        <input class="plugboard-config" id="plugboard-C" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-D">D</label>
                        <input class="plugboard-config" id="plugboard-D" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-E">E</label>
                        <input class="plugboard-config" id="plugboard-E" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-F">F</label>
                        <input class="plugboard-config" id="plugboard-F" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-G">G</label>
                        <input class="plugboard-config" id="plugboard-G" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-H">H</label>
                        <input class="plugboard-config" id="plugboard-H" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-I">I</label>
                        <input class="plugboard-config" id="plugboard-I" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-J">J</label>
                        <input class="plugboard-config" id="plugboard-J" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-K">K</label>
                        <input class="plugboard-config" id="plugboard-K" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-L">L</label>
                        <input class="plugboard-config" id="plugboard-L" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-M">M</label>
                        <input class="plugboard-config" id="plugboard-M" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-N">N</label>
                        <input class="plugboard-config" id="plugboard-N" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-O">O</label>
                        <input class="plugboard-config" id="plugboard-O" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-P">P</label>
                        <input class="plugboard-config" id="plugboard-P" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-Q">Q</label>
                        <input class="plugboard-config" id="plugboard-Q" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-R">R</label>
                        <input class="plugboard-config" id="plugboard-R" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-S">S</label>
                        <input class="plugboard-config" id="plugboard-S" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-T">T</label>
                        <input class="plugboard-config" id="plugboard-T" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-U">U</label>
                        <input class="plugboard-config" id="plugboard-U" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-V">V</label>
                        <input class="plugboard-config" id="plugboard-V" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-W">W</label>
                        <input class="plugboard-config" id="plugboard-W" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-X">X</label>
                        <input class="plugboard-config" id="plugboard-X" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-Y">Y</label>
                        <input class="plugboard-config" id="plugboard-Y" type="text">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="plugboard-Z">Z</label>
                        <input class="plugboard-config" id="plugboard-Z" type="text">
                    </td>
                </tr>
            </table>
        </div>

        <script type="text/javascript">
        $(document).ready(function() {
            var isValidInput = function(input) {
                return /^[a-zA-Z]*$/g.test(input);
            };

            var isAlphabeticChar = function(input) {
                return /^[a-zA-Z]$/g.test(input);
            };

            var isDifferentChar = function(input, current) {
                return (input !== current);
            };

            var isValidPlugboardConfig = function(input, current) {
                return (isAlphabeticChar(input)
                    && isDifferentChar(input, current));
            };

            var getPlugboardConfig = function() {
                var pairs = $('.plugboard-config').map(function() {
                    thisLetter = $(this).attr('id').slice(-1);
                    otherLetter = $(this).val().toUpperCase();

                    if (otherLetter)
                        return (thisLetter + otherLetter);
                }).get();

                return pairs;
            };

            var getRotorInstance = function(pos) {
                var type = $('#rotor-type-' + pos).val();

                if (type === 'I')
                    rotor = new RotorI();
                else if (type === 'II')
                    rotor = new RotorII();
                else if (type === 'III')
                    rotor = new RotorIII();
                else if (type === 'IV')
                    rotor = new RotorIV();
                else if (type === 'V')
                    rotor = new RotorV();

                return rotor;
            }

            var getReflectorInstance = function() {
                var reflector;

                if ($('#reflector-type').val() === 'B')
                    reflector = new ReflectorB();
                else if ($('#reflector-type').val() === 'C')
                    reflector = new ReflectorC();

                return reflector;
            }

            var encode = function(input) {
                getPlugboardConfig();

                var machine = new Machine();

                var plugboard = new Plugboard();
                plugboard.addPlugs.apply(plugboard, getPlugboardConfig());
                machine.setPlugboard(plugboard);

                var rightRotor = getRotorInstance('right');
                rightRotor.setInnerPosition($('#ring-right-pos').val());
                rightRotor.setInitialPosition($('#rotor-right-pos').val());

                var middleRotor = getRotorInstance('middle');
                middleRotor.setInnerPosition($('#ring-middle-pos').val());
                middleRotor.setInitialPosition($('#rotor-middle-pos').val());

                var leftRotor = getRotorInstance('left');
                leftRotor.setInnerPosition($('#ring-left-pos').val());
                leftRotor.setInitialPosition($('#rotor-left-pos').val());

                machine.setRotors(leftRotor, middleRotor, rightRotor);

                var reflector = getReflectorInstance();
                machine.setReflector(reflector);

                return machine.encodeLetters(input);
            };

            $('#enigma-input').keypress(function(e) {
                if (e.keyCode == 13)
                    $('#encode-btn').click();
            });

            $('#enigma-input').keyup(function(e) {
                input = $(this).val();
                validInput = input.replace(/([^a-zA-Z]+)/gi, '').toUpperCase();
                $(this).val(validInput);
                $('#enigma-output').val(encode(validInput));
            });

            $('.rotor-config').keydown(function(e) {
                e.preventDefault();
                letter = String.fromCharCode(e.keyCode).toUpperCase();

                if (isAlphabeticChar(letter))
                    $(this).val(letter);
            });

            $('.plugboard-config').keyup(function(e) {
                thisLetter = $(this).attr('id').slice(-1);
                otherLetter = $(this).val().toUpperCase();
                previousLetter = $(this).attr('previousLetter');

                if (previousLetter)
                    $('#plugboard-' + previousLetter).val('');

                if (isValidPlugboardConfig(otherLetter, thisLetter)) {
                    $(this).val(otherLetter);
                    $(this).attr('previousLetter', otherLetter);
                    $('#plugboard-' + otherLetter).val(thisLetter);
                } else {
                    $(this).attr('previousLetter', '');
                    $(this).val('');
                }
            });

            $('select[id^=rotor-type-]').change(function() {
                // Get a list of the ids that are selected
                var selected = [];
                $('[id^=rotor-type-] option:selected').each(function() {
                    selected.push($(this).val());
                });

                // Walk through every select option and enable if not
                // in the list and not already selected
                $('[id^=rotor-type-] option').each(function()
                {
                    if (!$(this).is(':selected'))
                    {
                        var shouldDisable = false;
                        for (var i = 0; i < selected.length; i++)
                        {
                            if (selected[i] == $(this).val())
                                shouldDisable = true;
                        }

                        $(this).css('text-decoration', '');
                        $(this).removeAttr('disabled', 'disabled');

                        if (shouldDisable) {
                            $(this).css('text-decoration', 'line-through');
                            $(this).attr('disabled', 'disabled');
                        }
                    }
                });
            });
        });
        </script>

        <footer>
            <p>Developed by <a href="http://www.matheusportela.com">Matheus V. Portela</a></p>
        </footer>
    </body>
</html>